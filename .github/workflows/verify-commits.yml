name: Verify Commit Messages

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  check-messages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetches all history for all branches and tags

      - name: Check for Issue Reference
        run: |
          # Get all commit messages in the PR
          commits=$(git log origin/${{ github.base_ref }}..origin/${{ github.head_ref }} --pretty=format:"%s")
          
          echo "Checking the following commits:"
          echo "$commits"
          
          # Regex for #123
          regex="(#[0-9]+)"

          while IFS= read -l line; do
            if [[ ! "$line" =~ $regex ]]; then
              echo "Error: Commit message '$line' is missing an issue reference (#123)"
              exit 1
            fi
          done <<< "$commits"
          
          echo "All commits contain a valid issue reference!"
